rules:
  - id: "NPM-001"
    name: "Suspicious eval/exec in lifecycle script"
    severity: "high"
    description: "Dynamic code execution (eval, exec, Function constructor) in npm scripts is often used for malware execution"
    patterns:
      - "\\beval\\s*\\("
      - "Function\\s*\\("
      - "\\bexec\\s*\\("
      - "execSync\\s*\\("
      - "execFile\\s*\\("
    recommendation: "Review the script manually. Remove dynamic code execution if not absolutely necessary. Consider using a static build process instead."

  - id: "NPM-002"
    name: "Base64 encoded content in lifecycle script"
    severity: "high"
    description: "Base64 encoding in npm scripts is commonly used to obfuscate malicious payloads"
    patterns:
      - "atob\\s*\\("
      - "Buffer\\.from\\s*\\([^)]+,\\s*['\"]base64['\"]\\)"
      - "[A-Za-z0-9+/]{40,}={0,2}"
    recommendation: "Decode and manually inspect the base64 content. Remove if suspicious or unnecessary."

  - id: "NPM-003"
    name: "Network calls in lifecycle scripts"
    severity: "medium"
    description: "Lifecycle scripts making network calls may be exfiltrating data or fetching malware"
    patterns:
      - "\\bcurl\\b"
      - "\\bwget\\b"
      - "https?://"
      - "fetch\\s*\\("
      - "axios\\."
      - "request\\s*\\("
      - "got\\s*\\("
      - "require\\s*\\(['\"]https?['\"]\\)"
      - "require\\s*\\(['\"]request['\"]\\)"
      - "require\\s*\\(['\"]axios['\"]\\)"
      - "require\\s*\\(['\"]got['\"]\\)"
      - "require\\s*\\(['\"]node-fetch['\"]\\)"
      - "https?\\.(?:get|request)\\s*\\("
      - "http?\\.(?:get|request)\\s*\\("
    recommendation: "Verify that network calls are legitimate and necessary. Check destination URLs carefully."

  - id: "NPM-004"
    name: "Environment variable access in lifecycle scripts"
    severity: "medium"
    description: "Accessing environment variables may indicate credential exfiltration attempts"
    patterns:
      - "process\\.env"
      - "\\$\\{[A-Z_][A-Z0-9_]*\\}"
      - "\\$[A-Z_][A-Z0-9_]*"
    recommendation: "Verify which environment variables are accessed and why. Be especially cautious of AWS_*, API_KEY, TOKEN, SECRET, PASSWORD variables."

  - id: "NPM-005"
    name: "Suspicious file system operations"
    severity: "low"
    description: "File operations outside expected paths may indicate malicious activity"
    patterns:
      - "\\.\\./.*"
      - "~/\\.ssh"
      - "~/\\.aws"
      - "/tmp/"
      - "/etc/"
      - "rm\\s+-rf"
    recommendation: "Check if file operations are expected for this package. Be cautious of operations in sensitive directories."

  - id: "NPM-006"
    name: "Shell command injection patterns"
    severity: "high"
    description: "Patterns that may allow shell command injection"
    patterns:
      - "child_process"
      - "spawn\\s*\\("
      - "/bin/sh"
      - "/bin/bash"
      - "\\|\\s*bash"
      - "\\|\\s*sh"
    recommendation: "Review for potential command injection vulnerabilities. Ensure user input is not passed to shell commands."

  - id: "NPM-007"
    name: "Obfuscated code in scripts"
    severity: "high"
    description: "Hex escapes, unicode escapes, or character code building indicates code obfuscation"
    patterns:
      - "\\\\x[0-9a-fA-F]{2}"
      - "\\\\u[0-9a-fA-F]{4}"
      - "String\\.fromCharCode"
      - "\\\\[0-7]{3}"
    recommendation: "Deobfuscate and inspect the code. Legitimate packages rarely use obfuscation."
